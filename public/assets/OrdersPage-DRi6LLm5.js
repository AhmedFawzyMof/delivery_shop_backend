import{d as T,c as f,m as $,a as e,b as d,e as r,t as a,w as u,f as i,i as c,r as p,s as x,x as j,M as le,z as de,v as ae,o as ue,y as ie,k as z,N as pe,O as ce,F as U,j as B,n as O}from"./index-TZd6v5Hm.js";import{a as fe,_ as S}from"./CustomPagination.vue_vue_type_script_setup_true_lang-C56SBDgm.js";import{b as W,d as Y,_ as F,g as E}from"./index-CQf1Xhsn.js";import{_ as H,b as J,c as K,d as k}from"./DropdownMenuTrigger.vue_vue_type_script_setup_true_lang-g-Y2GW1p.js";import{_ as me}from"./Checkbox.vue_vue_type_script_setup_true_lang-NypWs3Nd.js";import{_ as xe}from"./Sidebar.vue_vue_type_script_setup_true_lang-Ckioauwz.js";import{X as ve}from"./x-Dv3lmHrD.js";import{h as ge}from"./hasPermission-zJzLI1JE.js";import{_ as _e}from"./Textarea.vue_vue_type_script_setup_true_lang-Bz25nc14.js";import{S as be,F as Q}from"./search-CJLom1ik.js";import{E as ye}from"./eye-CSdyFiDX.js";import"./index-D4VFAAJq.js";import"./PopperContent--wvMB_Ff.js";import"./check-BuCm8Ksx.js";import"./index-DSgkQ9qN.js";const ke={key:0,class:"fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4"},$e={class:"bg-card border border-border rounded-lg max-w-2xl w-full max-h-[90vh] overflow-auto"},Ce={class:"flex items-center justify-between p-6 border-b border-border sticky top-0 bg-card"},we={class:"p-6 space-y-6",dir:"rtl"},he={class:"grid grid-cols-2 gap-6"},Oe={class:"text-lg font-bold text-foreground"},Se={class:"text-lg font-bold text-primary capitalize"},Ee={key:0,class:"bg-muted/30 rounded-lg p-4 space-y-3"},Fe={class:"bg-muted/30 rounded-lg p-4 space-y-3"},Ie={class:"grid grid-cols-2 gap-4"},je={class:"text-sm text-foreground"},De={class:"bg-muted/30 rounded-lg p-4 space-y-3"},Pe={class:"grid grid-cols-2 gap-4"},Ue={class:"text-sm text-foreground"},Me={class:"text-sm text-foreground"},Ne={class:"col-span-2"},Ve={class:"text-sm text-foreground"},ze={key:1,class:"bg-muted/30 rounded-lg p-4 space-y-3"},Be={class:"grid grid-cols-2 gap-4"},Te={class:"text-sm text-foreground"},Le={class:"text-sm text-foreground"},Re={class:"text-sm text-foreground capitalize"},Ae={class:"text-sm text-foreground"},Ge={key:2,class:"bg-orange-500/10 border border-orange-500/20 rounded-lg p-4"},qe={class:"bg-muted/30 rounded-lg p-4 space-y-3"},Xe={class:"space-y-2 text-sm"},He={class:"flex justify-between"},Je={class:"text-foreground font-medium"},Ke={class:"flex justify-between"},Qe={class:"text-foreground font-medium"},We={class:"flex justify-between"},Ye={class:"text-foreground font-medium"},Ze={class:"border-t border-border pt-2 flex justify-between"},et={class:"text-foreground font-bold"},tt={key:3,class:"bg-muted/30 rounded-lg p-4"},st={class:"text-sm text-foreground"},ot={class:"text-xs text-muted-foreground"},rt={class:"flex gap-3 p-6 border-t border-border bg-muted/20"},nt=T({__name:"OrderDitails",props:{order:{},isOpen:{type:Boolean},onEdit:{type:Function},onClose:{type:Function}},setup(C){const l=C;return(g,s)=>l.isOpen?(i(),f("div",ke,[e("div",$e,[e("div",Ce,[s[1]||(s[1]=e("h2",{class:"text-xl font-bold text-foreground"},"تفاصيل الطلب",-1)),e("button",{onClick:s[0]||(s[0]=(..._)=>l.onClose&&l.onClose(..._)),class:"p-1 hover:bg-muted rounded transition-colors"},[d(r(ve),{class:"w-5 h-5 text-foreground"})])]),e("div",we,[e("div",he,[e("div",null,[s[2]||(s[2]=e("p",{class:"text-xs text-muted-foreground uppercase"},"رقم الطلب",-1)),e("p",Oe," #"+a(l.order.order_id),1)]),e("div",null,[s[3]||(s[3]=e("p",{class:"text-xs text-muted-foreground uppercase"},"الحالة",-1)),e("p",Se,a(r(W)(l.order.order_status)),1)])]),l.order.cancelation_reason&&l.order.cancelation_reason!==""?(i(),f("div",Ee,[s[4]||(s[4]=e("h3",{class:"font-semibold text-foreground"},"سبب الإلغاء",-1)),e("p",null,a(l.order.cancelation_reason),1)])):$("",!0),e("div",Fe,[s[6]||(s[6]=e("h3",{class:"font-semibold text-foreground"},"معلومات العميل",-1)),e("div",Ie,[e("div",null,[s[5]||(s[5]=e("p",{class:"text-xs text-muted-foreground"},"الهاتف",-1)),e("p",je,a(l.order?.user_phone||"غير متوفر"),1)])])]),e("div",De,[s[10]||(s[10]=e("h3",{class:"font-semibold text-foreground"},"معلومات المطعم",-1)),e("div",Pe,[e("div",null,[s[7]||(s[7]=e("p",{class:"text-xs text-muted-foreground"},"الاسم",-1)),e("p",Ue,a(l.order?.restaurant_name||"غير معروف"),1)]),e("div",null,[s[8]||(s[8]=e("p",{class:"text-xs text-muted-foreground"},"المدينة",-1)),e("p",Me,a(l.order?.restaurant_city||"غير متوفر"),1)]),e("div",Ne,[s[9]||(s[9]=e("p",{class:"text-xs text-muted-foreground"},"العنوان",-1)),e("p",Ve,a(l.order?.restaurant_address||"غير متوفر"),1)])])]),l.order.driver_id?(i(),f("div",ze,[s[15]||(s[15]=e("h3",{class:"font-semibold text-foreground"},"معلومات السائق",-1)),e("div",Be,[e("div",null,[s[11]||(s[11]=e("p",{class:"text-xs text-muted-foreground"},"الاسم",-1)),e("p",Te,a(l.order.driver_full_name),1)]),e("div",null,[s[12]||(s[12]=e("p",{class:"text-xs text-muted-foreground"},"الهاتف",-1)),e("p",Le,a(l.order.driver_phone),1)]),e("div",null,[s[13]||(s[13]=e("p",{class:"text-xs text-muted-foreground"},"المركبة",-1)),e("p",Re,a(l.order.driver_type),1)]),e("div",null,[s[14]||(s[14]=e("p",{class:"text-xs text-muted-foreground"},"رقم اللوحة",-1)),e("p",Ae,a(l.order.plate_number),1)])])])):(i(),f("div",Ge,[...s[16]||(s[16]=[e("p",{class:"text-sm text-orange-700"}," لم يتم تعيين سائق لهذا الطلب بعد ",-1)])])),e("div",qe,[s[21]||(s[21]=e("h3",{class:"font-semibold text-foreground"},"ملخص الطلب",-1)),e("div",Xe,[e("div",He,[s[17]||(s[17]=e("span",{class:"text-muted-foreground"},"طريقة الدفع:",-1)),e("span",Je,a(r(Y)(l.order.payment_method)),1)]),e("div",Ke,[s[18]||(s[18]=e("span",{class:"text-muted-foreground"},"إجمالي الطلب:",-1)),e("span",Qe,a(l.order.order_total_price)+" ج.م",1)]),e("div",We,[s[19]||(s[19]=e("span",{class:"text-muted-foreground"},"تكلفة التوصيل:",-1)),e("span",Ye,a(l.order.order_delivery_cost)+" ج.م",1)]),e("div",Ze,[s[20]||(s[20]=e("span",{class:"text-foreground font-medium"},"الإجمالي الكلي:",-1)),e("span",et,a(l.order.order_total_price)+" ج.م",1)])])]),l.order.order_notes?(i(),f("div",tt,[s[22]||(s[22]=e("h3",{class:"font-semibold text-foreground mb-2"},"ملاحظات",-1)),e("p",st,a(l.order.order_notes),1)])):$("",!0),e("div",ot," تم إنشاء الطلب في "+a(new Date(l.order.created_at).toLocaleString("ar-EG")),1)]),e("div",rt,[d(r(F),{onClick:l.onClose,variant:"outline"},{default:u(()=>[...s[23]||(s[23]=[c("إغلاق",-1)])]),_:1},8,["onClick"])])])])):$("",!0)}}),lt={key:0,class:"fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4"},dt={class:"bg-card border border-border rounded-lg max-w-3xl w-full max-h-[90vh] overflow-auto"},at={class:"p-6"},ut={class:"flex gap-3 p-6 border-t border-border bg-muted/20"},it=T({__name:"CancellationReasonModal",props:{isOpen:{type:Boolean},orderId:{},onClose:{type:Function}},setup(C){const l=C,g=p(!1),s=p({cancellation_reason:"",order_status:"canceled"}),_=async()=>{try{if(g.value=!0,!s.value.cancellation_reason||s.value.cancellation_reason.trim()===""){x.error("يرجى ملء سبب الإلغاء.");return}if(l.orderId===void 0){x.error("معرف الطلب غير صالح.");return}await j.put(`/orders/admin/${l.orderId}`,{cancellation_reason:s.value.cancellation_reason,order_status:"canceled"}),x.success("تم إلغاء الطلب بنجاح"),l.onClose()}catch{x.error("حدث خطأ أثناء الحفظ. يرجى المحاولة مرة أخرى.")}finally{g.value=!1}};return(D,v)=>C.isOpen?(i(),f("div",lt,[e("div",dt,[e("div",at,[v[1]||(v[1]=e("h2",{class:"text-lg font-medium mb-4"},"سبب إلغاء الطلب",-1)),d(r(_e),{modelValue:s.value.cancellation_reason,"onUpdate:modelValue":v[0]||(v[0]=w=>s.value.cancellation_reason=w),type:"text",placeholder:"أدخل سبب الإلغاء هنا...",class:"w-full"},null,8,["modelValue"])]),e("div",ut,[d(r(F),{onClick:C.onClose,variant:"outline"},{default:u(()=>[...v[2]||(v[2]=[c(" إغلاق ",-1)])]),_:1},8,["onClick"]),d(r(F),{onClick:_,disabled:g.value},{default:u(()=>[c(a(g.value?"جاري الحفظ...":"حفظ التغييرات"),1)]),_:1},8,["disabled"])])])])):$("",!0)}}),pt={class:"p-4 flex items-center flex-col sm:flex-row gap-4"},ct={class:"flex-1 relative"},ft={class:"flex gap-2"},mt={class:"p-4 grid grid-cols-4 gap-2"},xt={class:"drivers border rounded-lg overflow-y-auto h-[600px] col-span-1"},vt=["onClick"],gt={key:1,class:"w-full h-full flex items-center justify-center p-4"},_t={class:"col-span-3 bg-card border rounded-lg"},bt={class:"overflow-x-auto"},yt={class:"w-full"},kt={key:0},$t={class:"px-6 py-4 text-sm font-medium text-foreground"},Ct={class:"px-6 py-4 text-sm text-foreground"},wt={class:"px-6 py-4 text-sm font-medium text-foreground"},ht={class:"px-6 py-4 text-sm text-foreground"},Ot={class:"px-6 py-4 text-sm text-foreground"},St={class:"px-6 py-4 text-sm text-foreground"},Et={class:"px-6 py-4 text-sm text-foreground"},Ft={class:"relative px-6 py-4 group"},It={key:0,class:"hidden absolute z-50 bg-white rounded border p-2 group-hover:flex items-center flex-col gap-2"},jt={class:"px-6 py-4 text-sm text-muted-foreground"},Dt={class:"px-6 py-4 text-right flex items-center gap-2"},Pt=50,Kt=T({__name:"OrdersPage",setup(C){const l=p(""),g=p(null),s=p(null),_=p(1),D=p(0),v=p(null),w=p(!1),M=p(!1),L=p(0),b=p([]),Z=le();let P=null;const R=p([]),A=de({get(){const n={};for(const t of b.value)n[t]=!0;return n},set(n){b.value=Object.keys(n).filter(t=>n[Number(t)]).map(Number)}});function ee(n,t=500){let o;return(...m)=>{clearTimeout(o),o=window.setTimeout(()=>n(...m),t)}}const N=p([]),y=async()=>{try{const n=new URLSearchParams;n.append("page",_.value.toString()),l.value.trim()!==""&&n.append("search",encodeURIComponent(l.value.trim())),g.value&&n.append("status",g.value),s.value&&n.append("city",s.value);const t=await j.get(`/orders/admin?${n.toString()}`);N.value=t.data.orders,L.value=t.data.totalOrders,R.value=t.data.cities.map(o=>o.city_name)}catch(n){console.error("حدث خطأ أثناء جلب البيانات:",n)}},te=ee(y,500),h=n=>{g.value=n,_.value=1,y()},G=n=>{s.value=n,_.value=1,y()};async function I(n,t){if(t==="canceled"){M.value=!0,D.value=n;return}try{(await j.put(`/orders/admin/${n}`,{order_status:t})).data.success&&(x.success(`تم تحديث حالة الطلب رقم ${n} بنجاح`),await y())}catch(o){if(o.response){const m=o.response.data?.message||"حدث خطأ أثناء تعديل حالة الطلب";if(console.error("API Error:",o.response),o.response.status===403){x.error("لا يمكنك القيام بهذا الإجراء، أنت غير مسموح لك");return}x.error(m);return}if(o.request){console.error("Network Error:",o.request),x.error("تعذر الاتصال بالسيرفر");return}console.error("Unexpected Error:",o),x.error("حدث خطأ غير متوقع")}}function se(n){v.value=n,w.value=!0}function oe(n){if(!b.value.includes(n)){b.value.push(n);return}b.value=b.value.filter(t=>t!==n)}function re(n){switch(n){case"picked-up":return!1;case"delivered":return!1;case"canceled":return!1;default:return!0}}const V=p([]),q=p(!1),X=async()=>{try{q.value=!0;const n=await j.get("/driver/active");V.value=n.data.drivers}catch(n){console.error("حدث خطأ أثناء جلب السائقين:",n)}finally{q.value=!1}},ne=async n=>{if(!n){x.error("اختر سائق أولاً");return}if(b.value.length===0){x.error("اختر طلب واحد على الأقل");return}try{await j.post("/orders/assign",{driver_id:n,orders:b.value}),x.success("تم تعيين السائق بنجاح"),b.value=[],await y()}catch(t){console.error("حدث خطأ أثناء تعيين السائق:",t),x.error("فشل تعيين السائق")}};return ae(l,()=>{te()}),ue(async()=>{await y(),await X(),P=window.setInterval(()=>{X()},2e4)}),ie(()=>{P&&(clearInterval(P),P=null)}),(n,t)=>(i(),f(U,null,[d(xe),t[29]||(t[29]=e("div",{class:"p-4",dir:"rtl"},[e("h1",{class:"text-3xl font-bold text-foreground"},"الطلبات"),e("p",{class:"text-muted-foreground mt-1"},"إدارة ومتابعة جميع طلبات التوصيل")],-1)),e("div",pt,[e("div",ct,[d(r(be),{class:"absolute left-3 top-1/2 transform -translate-y-1/2 w-4 h-4 text-muted-foreground"}),pe(e("input",{type:"text",placeholder:"ابحث برقم الطلب...","onUpdate:modelValue":t[0]||(t[0]=o=>l.value=o),class:"w-full pl-10 pr-4 py-2 bg-card border border-border rounded-lg text-foreground placeholder-muted-foreground focus:outline-none focus:ring-2 focus:ring-primary"},null,512),[[ce,l.value]])]),e("div",ft,[d(r(H),null,{default:u(()=>[d(r(J),{asChild:""},{default:u(()=>[d(r(F),{variant:"outline",class:"gap-2 bg-transparent"},{default:u(()=>[d(r(Q),{class:"w-4 h-4"}),c(" "+a(s.value?`المدينة: ${s.value}`:"المدينة"),1)]),_:1})]),_:1}),d(r(K),null,{default:u(()=>[d(r(k),{onClick:t[1]||(t[1]=o=>G(null))},{default:u(()=>[...t[12]||(t[12]=[c("كل المدن",-1)])]),_:1}),(i(!0),f(U,null,B(R.value,o=>(i(),z(r(k),{key:o,onClick:m=>G(o)},{default:u(()=>[c(a(o),1)]),_:2},1032,["onClick"]))),128))]),_:1})]),_:1}),d(r(H),null,{default:u(()=>[d(r(J),{asChild:""},{default:u(()=>[d(r(F),{variant:"outline",class:"gap-2 bg-transparent"},{default:u(()=>[d(r(Q),{class:"w-4 h-4"}),t[13]||(t[13]=c(" الحالة ",-1))]),_:1})]),_:1}),d(r(K),null,{default:u(()=>[d(r(k),{onClick:t[2]||(t[2]=o=>h(null))},{default:u(()=>[...t[14]||(t[14]=[c(" كل الطلبات ",-1)])]),_:1}),d(r(k),{onClick:t[3]||(t[3]=o=>h("pending"))},{default:u(()=>[...t[15]||(t[15]=[c(" قيد الانتظار ",-1)])]),_:1}),d(r(k),{onClick:t[4]||(t[4]=o=>h("ready"))},{default:u(()=>[...t[16]||(t[16]=[c(" جاهز للاستلام ",-1)])]),_:1}),d(r(k),{onClick:t[5]||(t[5]=o=>h("picked-up"))},{default:u(()=>[...t[17]||(t[17]=[c(" تم التعيين ",-1)])]),_:1}),d(r(k),{onClick:t[6]||(t[6]=o=>h("delivered"))},{default:u(()=>[...t[18]||(t[18]=[c(" تم التسليم ",-1)])]),_:1}),d(r(k),{onClick:t[7]||(t[7]=o=>h("canceled"))},{default:u(()=>[...t[19]||(t[19]=[c(" ملغي ",-1)])]),_:1})]),_:1})]),_:1})])]),e("div",mt,[e("div",xt,[V.value.length>0?(i(!0),f(U,{key:0},B(V.value,o=>(i(),f("div",{class:"driver text-right py-1 px-1 border-b cursor-pointer",key:o.driver_id,onClick:m=>ne(o.driver_id)},[e("p",null,a(o.driver_name),1),e("p",null,a(o.driver_city),1)],8,vt))),128)):(i(),f("div",gt,[...t[20]||(t[20]=[e("p",null,"لا يوجد سأقين موتحين",-1)])]))]),e("div",_t,[e("div",bt,[e("table",yt,[t[28]||(t[28]=e("thead",null,[e("tr",{class:"border-b border-border bg-muted/30"},[e("th",{class:"px-6 py-4 text-left text-xs font-medium text-muted-foreground uppercase"}," رقم الطلب "),e("th",{class:"px-6 py-4 text-left text-xs font-medium text-muted-foreground uppercase"}," المطعم "),e("th",{class:"px-6 py-4 text-left text-xs font-medium text-muted-foreground uppercase"}," الإجمالي "),e("th",{class:"px-6 py-4 text-left text-xs font-medium text-muted-foreground uppercase"}," التوصيل "),e("th",{class:"px-6 py-4 text-left text-xs font-medium text-muted-foreground uppercase"}," طريقة الدفع "),e("th",{class:"px-6 py-4 text-left text-xs font-medium text-muted-foreground uppercase"}," السائق "),e("th",{class:"px-6 py-4 text-left text-xs font-medium text-muted-foreground uppercase"}," المدينه "),e("th",{class:"px-6 py-4 text-left text-xs font-medium text-muted-foreground uppercase"}," الحالة "),e("th",{class:"px-6 py-4 text-left text-xs font-medium text-muted-foreground uppercase"}," التاريخ "),e("th",{class:"px-6 py-4 text-right text-xs font-medium text-muted-foreground uppercase"}," الإجراءات ")])],-1)),e("tbody",null,[N.value.length===0?(i(),f("tr",kt,[...t[21]||(t[21]=[e("td",{colspan:"9",class:"px-6 py-8 text-center text-muted-foreground"}," لا يوجد طلبات ",-1)])])):$("",!0),(i(!0),f(U,null,B(N.value,o=>(i(),f("tr",{key:o.order_id,class:"border-b border-border hover:bg-muted/50 transition-colors"},[e("td",$t," #"+a(o.order_id),1),e("td",Ct,a(o.restaurant_name),1),e("td",wt," ج.م "+a(o.order_total_price.toFixed(2)),1),e("td",ht," ج.م "+a(o.order_delivery_cost.toFixed(2)),1),e("td",Ot,a(r(Y)(o.payment_method)),1),e("td",St,a(o.driver_full_name||"غير مخصص"),1),e("td",Et,a(o.order_city),1),e("td",Ft,[d(r(S),{class:O(r(E)(o.order_status))},{default:u(()=>[c(a(r(W)(o.order_status)),1)]),_:2},1032,["class"]),r(ge)(r(Z).user.data?.role.permissions,"order:edit")?(i(),f("div",It,[d(r(S),{class:O([r(E)("preparing"),"w-full cursor-pointer"]),onClick:m=>I(o.order_id,"preparing")},{default:u(()=>[...t[22]||(t[22]=[e("p",null,"في التحضير",-1)])]),_:1},8,["class","onClick"]),d(r(S),{class:O([r(E)("ready"),"w-full cursor-pointer"]),onClick:m=>I(o.order_id,"ready")},{default:u(()=>[...t[23]||(t[23]=[e("p",null,"جاهز للاستلام",-1)])]),_:1},8,["class","onClick"]),d(r(S),{class:O([r(E)("picked-up"),"w-full cursor-pointer"]),onClick:m=>I(o.order_id,"picked-up")},{default:u(()=>[...t[24]||(t[24]=[e("p",null,"تم الاستلام",-1)])]),_:1},8,["class","onClick"]),d(r(S),{class:O([r(E)("delivered"),"w-full cursor-pointer"]),onClick:m=>I(o.order_id,"delivered")},{default:u(()=>[...t[25]||(t[25]=[e("p",null,"تم التوصيل",-1)])]),_:1},8,["class","onClick"]),d(r(S),{class:O([r(E)("canceled"),"w-full cursor-pointer"]),onClick:m=>I(o.order_id,"canceled")},{default:u(()=>[...t[26]||(t[26]=[e("p",null,"ملغي",-1)])]),_:1},8,["class","onClick"])])):$("",!0)]),e("td",jt,a(new Date(o.created_at).toLocaleDateString("ar-EG")),1),e("td",Dt,[d(r(F),{onClick:m=>se(o)},{default:u(()=>[d(r(ye),{class:"w-4 h-4 mr-2"}),t[27]||(t[27]=c(" التفاصيل ",-1))]),_:1},8,["onClick"]),re(o.order_status)?(i(),z(r(me),{key:0,onClick:m=>oe(o.order_id),checked:A.value[o.order_id],"onUpdate:checked":m=>A.value[o.order_id]=m},null,8,["onClick","checked","onUpdate:checked"])):$("",!0)])]))),128))])])]),d(fe,{dir:"rtl","current-page":_.value,"total-items":L.value,"items-per-page":Pt,"onUpdate:currentPage":t[8]||(t[8]=o=>_.value=o)},null,8,["current-page","total-items"])])]),d(it,{isOpen:M.value,orderId:D.value,onClose:t[9]||(t[9]=()=>{M.value=!1,y()})},null,8,["isOpen","orderId"]),v.value?(i(),z(nt,{key:0,order:v.value,isOpen:w.value,onClose:t[10]||(t[10]=o=>w.value=!1),onEdit:t[11]||(t[11]=()=>{w.value=!1,y()})},null,8,["order","isOpen"])):$("",!0)],64))}});export{Kt as default};
